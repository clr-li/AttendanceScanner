<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Home</title>
    <meta name="description" content="A program to automate attendance">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- import the webpage's stylesheet -->
    <link rel="stylesheet" href="/style.css">
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    
    <!--   Import QR generating capabilities   -->
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js" integrity="sha256-+C0A5Ilqmu4QcSPxrlGpaZxJ04VjsRjKu+G82kl5UJk=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.bootstrap3.min.css" integrity="sha256-ze/OEYGcFbPRmvCnrSeKbRTtjG4vGLHXgOqsyLFTRjg=" crossorigin="anonymous" />
  </head>
  <body>
    <h1 id="header">
      Admin Page 
    </h1>
<!--     <h2 id="businessname"></h2> -->
    <select id="businessname" />
    <h3>Join Info</h3>
    <div id="qrcode"></div>
    <a id="joinlink">Join Link</a><br><br>
    <script type="module">
      import {GET, POST} from './util.js';
      let res = await GET('/joincode');
      let data = await res.json();
      let joincode = data.joincode;
      let businessId = data.id;
      let joinlink = "https://" + window.location.hostname + "/user.html?id=" + businessId + "&code=" + joincode;
      new QRCode(document.getElementById("qrcode"), joinlink);
      document.getElementById("joinlink").href = joinlink;
      document.getElementById("joinlink").textContent = joinlink;
    </script>
    <label for="events">Event: </label>
    <select id="events" name="events"></select>
    <br>
    <div id="eventdetails"></div>
    <button id="newevent"> 
      New Event
    </button>
    <form id="eventform" style="display: none;">
      <label for="name">Event Name: </label>
      <input type="text" id="name" name="name">
      <label for="description">Description: </label>
      <input type="text" id="description" name="description"><br>
      <label for="startdate">Start Date: </label>
      <input type="date" id="startdate" name="startdate"><br>
      <label for="starttime">Start Time: </label>
      <input type="time" id="starttime" name="starttime"><br>
      <label for="enddate">End Date: </label>
      <input type="date" id="enddate" name="enddate"><br>
      <label for="endtime">End Time: </label>
      <input type="time" id="endtime" name="endtime"><br>
      <input type="button" value="Submit" id="submitevent">
    </form>
    <form id="filterform" onsubmit="return false">
      <label for="filtername">Filter by Name: </label>
      <input type="text" id="filtername" name="filtername">
      <label for="filterstart">Start Date: </label>
      <input type="date" id="filterstart" name="filterstart"><br>
      <label for="filterend">End Date: </label>
      <input type="date" id="filterend" name="filterend"><br>
      <button value="Submit" id="submitfilter">Submit</button>
    </form>
    <table id="displayattendance"></table>
    
    <script type="module">
    import {GET, POST, calcSimilarity} from './util.js';
      
    let selectizeControl;
    let select;
    let events;
    async function updateEvents() {
      let options = [];
      let res = await GET('/events?businessId=' + );
      events = await res.json();
      events.forEach(event => {
        let option = {};
        var startDate = new Date(event.starttimestamp*1000);
        var endDate = new Date(event.endtimestamp*1000);
        option.title = event.name + " — " + "from " + startDate.toDateString() + " to " + endDate.toDateString();
        option["data-id"] = event.id;
        options.push(option);
      });      
      if (selectizeControl) {
        selectizeControl.destroy();
      }
      select = $('#events').selectize({
          placeholder: "Pick an event...",
          valueField: 'data-id',
          labelField: 'title',
          searchField: 'title',
          sortField: 'title',
          options: options
      });
      selectizeControl = select[0].selectize;
    }
      
    document.getElementById('submitevent').addEventListener('click', () => {
      console.log("adding event");
      const name = document.getElementById('name').value;
      const description = document.getElementById('description').value;
      
      const startdate = document.getElementById('startdate').value;
      const starttime = document.getElementById('starttime').value;
      const enddate = document.getElementById('enddate').value;
      const endtime = document.getElementById('endtime').value;
      const starttimestamp = (new Date(startdate + 'T' + starttime)).getTime() / 1000;
      const endtimestamp = (new Date(enddate + 'T' + endtime)).getTime() / 1000;
      
      
      const userids = "*";
      GET(`/makeEvent?name=${name}&description=${description}&starttimestamp=${starttimestamp}&endtimestamp=${endtimestamp}&userids=${userids}`).then(async (res) => { 
        console.log(res.status);
        let id = (await res.json())["last_insert_rowid()"];
        let option = {};
        var startDate = new Date(starttimestamp*1000);
        var endDate = new Date(endtimestamp*1000);
        option.title = name + " — " + "from " + startDate.toDateString() + " to " + endDate.toDateString();
        option["data-id"] = id;
        console.log(option)
        selectizeControl.addOption(option);
        selectizeControl.refreshOptions();
        selectizeControl.addItem(id);
      });
    });
          
    document.getElementById('submitfilter').onclick = () => {
      [...document.getElementById('displayattendance').firstChild.querySelectorAll("tr")].forEach ((row) => {
        if (row.firstChild.nodeName == 'TD' && document.getElementById('filtername').value != "") {
          // if (row.firstChild.innerHTML != document.getElementById('filtername').value) {
          //   row.style.display = "none";
          // } else {
          //   row.style.display = "table-row";
          // }
          sortStudents(document.getElementById('filtername').value);
        } else {
          row.style.display = "table-row";
        }
      });
      [...document.getElementsByClassName('cell')].forEach((cell) => {
        let showstart = document.getElementById("filterstart").value != "";
        let showend = document.getElementById("filterend").value != "";
        let showCell = true;
        if (showstart) {
          showCell = showCell && (new Date(document.getElementById("filterstart").value + 'T00:00')).getTime() / 1000 < cell.dataset.time;
        }
        if (showend) {
          showCell = showCell && (new Date(document.getElementById("filterend").value + 'T23:59')).getTime() / 1000 > cell.dataset.time;
        }
        if (showCell) {
          cell.style.display = "table-cell";
        } else {
          cell.style.display = "none";
        }
      });
    }
    
    function sortStudents(searchword) {
      searchword = searchword.toLowerCase();
      var table, rows, switching, i, x, y, shouldSwitch;
      table = document.getElementById("displayattendance");
      switching = true;
      /* Make a loop that will continue until
      no switching has been done: */
      while (switching) {
        // Start by saying: no switching is done:
        switching = false;
        rows = table.rows;
        /* Loop through all table rows (except the
        first, which contains table headers): */
        for (i = 1; i < (rows.length - 1); i++) {
          // Start by saying there should be no switching:
          shouldSwitch = false;
          /* Get the two elements you want to compare,
          one from current row and one from the next: */
          x = rows[i].getElementsByTagName("TD")[0];
          y = rows[i + 1].getElementsByTagName("TD")[0];
          // Check if the two rows should switch place:
          if (calcSimilarity(x.innerHTML.toLowerCase(), searchword) < calcSimilarity(y.innerHTML.toLowerCase(), searchword)) {
            // If so, mark as a switch and break the loop:
            shouldSwitch = true;
            break;
          }
        }
        if (shouldSwitch) {
          /* If a switch has been marked, make the switch
          and mark that a switch has been done: */
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
        }
      }
    }
      
    document.getElementById('newevent').onclick = () => {
      if (document.getElementById('eventform').style.display == 'block') {
        document.getElementById('eventform').style.display = 'none';
      } else {
        document.getElementById('eventform').style.display = 'block';
      }
    }
      
    document.body.onload = async () => {
      GET('/businesses').then((res) => { res.json().then((o) => {
        let html = '';
        o.forEach(business => {
          if (business.role != 'user')
            html += `<option data-id="${business.id}">${business.name}</option>`;
        });
        document.getElementById("businessname").innerHTML = html;
      })});
      await updateEvents();
      
      function getEventData() {
        let eventid = selectizeControl.getValue();
        GET(`/eventdata?eventid=${eventid}`).then((res) => res.json().then((eventinfo) => {
          var startDate = new Date(eventinfo.starttimestamp*1000);
          var endDate = new Date(eventinfo.endtimestamp*1000);
          document.getElementById("eventdetails").innerHTML = `
          Name: <input type="text" value="${eventinfo.name}" id="update-name"><br>
          Start Date: <input type="date" value="${startDate.toLocaleDateString('en-CA')}" id="update-startdate">
          Start Time: <input type="time" value="${(startDate.getHours()+100+"").substr(-2)}:${("" + startDate.getMinutes()).padStart(2, '0')}" id="update-starttime"><br>
          End Date: <input type="date" value="${endDate.toLocaleDateString('en-CA')}" id="update-enddate">
          End Time: <input type="time" value="${(endDate.getHours()+100+"").substr(-2)}:${("" + endDate.getMinutes()).padStart(2, '0')}" id="update-endtime"><br>
          Description: <input type="text" value="${eventinfo.description}" id="update-description">
          <br><button id="update">Update Event</button><br>
          <button id="delete">Delete Event</button><br>
          <button id="scan">
            Scanner
          </button><br><br>
          `;
          document.getElementById('scan').onclick = () => {
            let id = selectizeControl.getValue();
            window.open(`scanner.html?eventid=${id}`)
          };
          document.getElementById('delete').onclick = () => {
            GET(`/deleteevent?eventid=${eventid}`).then((res) => {
              console.log(res.status);
              selectizeControl.removeOption(eventid);
            })
            
          };
          document.getElementById('update').onclick = () => {
            const name = document.getElementById('update-name').value;
            const description = document.getElementById('update-description').value;

            const startdate = document.getElementById('update-startdate').value;
            const starttime = document.getElementById('update-starttime').value;
            const enddate = document.getElementById('update-enddate').value;
            const endtime = document.getElementById('update-endtime').value;
            const starttimestamp = (new Date(startdate + 'T' + starttime)).getTime() / 1000;
            const endtimestamp = (new Date(enddate + 'T' + endtime)).getTime() / 1000;
            GET(`/updateevent?eventid=${eventid}&name=${name}&description=${description}&starttimestamp=${starttimestamp}&endtimestamp=${endtimestamp}`).then((res) => {
              document.getElementsByClassName('item')[0].innerHTML = name + " — " + "from " + (new Date(starttimestamp*1000)).toDateString() + " to " + (new Date(endtimestamp*1000)).toDateString();
              console.log(res.status);
              updateEvents();
            })
          }
        }));
      }
      
      selectizeControl.on('change', getEventData);
      let attendancearr = await (await GET(`/attendancedata?eventid=*&userid=*`)).json();
      let map = new Map();
      for (let i = 0; i < attendancearr.length; i++) {
        if(!map.has(attendancearr[i].userid)) {
          map.set(attendancearr[i].userid, []);
        }
        map.get(attendancearr[i].userid).push(attendancearr[i]);
      }
      let html = "<tr><th>Name (id)</th>"; 
      for (let i = 0; i < events.length; i++) {
        var startDate = new Date(events[i].starttimestamp*1000);
        var endDate = new Date(events[i].endtimestamp*1000);
        html += `<th class="cell" data-time="${events[i].starttimestamp}">${events[i].name}: ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}</th>`;
      }
      html += "</tr>";
      for (let i = 0; i < [...map.keys()].length; i++) {
        let userid = [...map.keys()][i];
        let records = map.get(userid);
        html += `<tr><td>${records[0].FirstName} ${records[0].LastName} (${userid.substr(0,4)})</td>`;
        for (let j = 0; j < events.length; j++) {   
          let statusupdate = false;
          for (let k = 0; k < records.length; k++) {
            if (records[k].eventid == events[j].id) {
              html += `<td class="cell" data-time="${events[j].starttimestamp}">${records[k].status}</td>`;
              statusupdate = true;
              break;
            }
          }
          if (!statusupdate) {
            html += `<td class="cell" data-time="${events[j].starttimestamp}">N/A</td>`;
          }
        }
        html += "</tr>";
      }
      document.getElementById("displayattendance").innerHTML = html;
    };
    </script>
  </body>
</html>